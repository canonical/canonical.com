{#
    All Params:
      @param title_text: H2 title text
      @param input_label: Label for the input field
      @param checkbox_id: Name for the checkbox field, used for agreeing to something before submitting the form. This may vary based on the backend used to collect form responses.
      @param checkbox_label: Label for the checkbox
      @param layout: Layout variant for the section. Options are "50-50", "25-75", "2-col", and "4-col". Default is "25-75".
      @param form_id: Form ID
      @param form_action: Action URL for the form submission, typically the form endpoint.
      @param return_url: URL to return to after form submission
      @param top_rule_variant (string) (optional): Variant of the top rule, default is "default". Options are "muted", "highlighted", "default", "none".

    All Slots:
      @slot description: Description text, one or more paragraphs
      @slot addendum: Additional content to include in the form, such as a disclaimer or additional information
      @slot hidden_fields: Additional hidden fields to include in the form
#}
{%- macro vf_newsletter_signup(form_id, return_url, title_text, form_action="https://ubuntu.com/marketo/submit", input_label="Work email", checkbox_id="canonicalUpdatesOptIn", checkbox_label="I agree to receive information about Canonical's products and services.", layout="25-75", top_rule_variant="default", caller=None) -%}
  {% set layout = layout | trim %}
  {% if layout not in ['50-50', '25-75', '2-col', '4-col'] %}
    {% set layout = "25-75" %}
  {% endif %}
  {% set top_rule_variant = top_rule_variant | trim %}
  {% if top_rule_variant not in ['muted', 'highlighted', 'default', 'none'] %}
    {% set top_rule_variant = "default" %}
  {% endif %}
  {% set description = caller('description') %}
  {% set addendum = caller('addendum') %}
  {% set hidden_fields = caller('hidden_fields') %}
  {% set is_section_level = layout in ['50-50', '25-75'] %}
  {% set is_grid_level = layout in ['2-col', '4-col'] %}
  {% set heading_level = 'h2' if is_section_level else 'h3' %}
  {%- macro _top_rule() -%}
    {% if top_rule_variant != 'none' %}
      {% set rule_class = 'muted' if top_rule_variant == 'muted' else 'highlight' if top_rule_variant == 'highlighted' %}
      <hr class="p-rule{% if top_rule_variant != 'default' %}--{{ rule_class }}{% endif %} is-fixed-width" />
    {% endif %}
  {%- endmacro -%}
  {%- if is_section_level -%}
    <section class="p-section--deep u-fixed-width" id="newsletter">
    {%- endif -%}
    {{ _top_rule() | safe }}
    <div class="row--{% if is_section_level %}{{ layout }}-on-large{% else %}25-25-25-25{% endif %}">
      {% if is_grid_level %}
        {%- set upper_limit = 4 if layout == '2-col' else 3 -%}
        {%- for number in range(1, upper_limit) -%}
          {%- set col_content = caller('col_' + number|string) -%}
          <div class="col">{{ col_content | safe }}</div>
        {%- endfor -%}
      {% endif %}
      <div class="col{% if layout == '4-col' %}-4{% endif %} {% if is_grid_level %}p-newsletter-signup--{{ layout }}{% endif %}">
        {%- if is_grid_level -%}
          <hr class="p-rule--muted u-hide--large {% if layout == '2-col' %}u-hide--medium{% endif %}" />
        {%- endif -%}
        <{{ heading_level }}>{{ title_text }}</{{ heading_level }}>
        {% if is_section_level %}</div>{% endif %}
      {% if is_section_level %}<div class="col">{% endif %}
        {{ description | safe }}
        <form action="{{ form_action }}" method="post" id="{{ form_id }}">
          <label class="is-required" for="email">{{ input_label }}:</label>
          <input required
                 id="email"
                 name="email"
                 maxlength="255"
                 type="email"
                 pattern="^[^ ]+@[^ ]+\.[a-z]{2,26}$"
                 required="required" />
          <label class="p-checkbox is-required">
            <input required
                   class="p-checkbox__input"
                   value="yes"
                   aria-labelledby="{{ checkbox_id }}"
                   name="{{ checkbox_id }}"
                   type="checkbox" />
            <span class="p-checkbox__label" id="{{ checkbox_id }}">{{ checkbox_label }}</span>
          </label>
          {% if addendum %}
            {{ addendum | safe }}
          {% else %}
            <p>
              By submitting this form, I confirm that I have read and agree to <a href="/legal/data-privacy">Canonical's Privacy Policy</a>.
            </p>
          {% endif %}
          <button type="submit" class="u-no-margin--bottom">Sign up</button>
          {% if hidden_fields %}
            {{ hidden_fields | safe }}
          {% else %}
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="returnURL"
                   value="{{ return_url }}" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="formid"
                   value="{{ form_id }}" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="productContext"
                   id="product-context"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="utm_campaign"
                   id="utm_campaign"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="utm_medium"
                   id="utm_medium"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="utm_source"
                   id="utm_source"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="utm_content"
                   id="utm_content"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="utm_term"
                   id="utm_term"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="GCLID__c"
                   id="GCLID__c"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   name="Facebook_Click_ID__c"
                   id="Facebook_Click_ID__c"
                   value="" />
            <input type="hidden"
                   aria-hidden="true"
                   aria-label="hidden field"
                   id="preferredLanguage"
                   name="preferredLanguage"
                   maxlength="255"
                   value="" />
          {% endif %}
        </form>
      </div>
    </div>
    {%- if is_section_level -%}
    </section>
  {%- endif -%}
{%- endmacro -%}